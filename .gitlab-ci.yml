image: docker:latest

services:
  - docker:dind

stages:
    - build
    - push
    
before_script:
   - docker info


build-master:
  stage: build
  script:
    - docker info 
    - docker build -t "$REGISTRY_IMAGE" -t "$MAJOR_VERSION" ./api
  only:
    - master

push-master:
   stage: push
   script:
     - echo "$REGISTRY_PWD" | docker login -u "$REGISTRY_USER" --password-stdin
     - docker push "$REGISTRY_IMAGE" 
   only:
     - master
